@page "/"
@using BlazorTemplater
@using QRCodeGenerator.Pages.Atoms
@using QRCoder
@using System.Text
@using System.ComponentModel.DataAnnotations
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>QRCodeGenerator</PageTitle>

<h1>QRCodeGenerator</h1>

<div class="qr-container mt-3">
    <div class="qr-preview qr-preview-lg">
        <label class="form-label">プレビュー</label>
        <div class="qr-image border border-1 border-dark rounded rounded-2">
            <QRCodeSvg Level="@_model!.Level" Body="@_model!.Body" width="100%" height="100%" />
        </div>
    </div>

    <EditForm class="qr-form d-flex flex-column gap-3" Model="_model" OnValidSubmit="OnGenerateAsync">
        <DataAnnotationsValidator />

        <div>
            <label class="form-label" for="ECCLevelBox">誤り訂正レベル</label>
            <InputSelect class="form-select" id="ECCLevelBox" TValue="QRCodeGenerator.ECCLevel" @bind-Value="_model!.Level">
                <option value="@QRCodeGenerator.ECCLevel.L">レベルL（7%）</option>
                <option value="@QRCodeGenerator.ECCLevel.M">レベルM（15%）</option>
                <option value="@QRCodeGenerator.ECCLevel.Q">レベルQ（25%）</option>
                <option value="@QRCodeGenerator.ECCLevel.H">レベルH（30%）</option>
            </InputSelect>
        </div>

        <div>
            <label class="form-label" for="BodyBox">内容</label>
            <textarea class="form-control" rows="3" id="BodyBox" @bind="Body" @bind:event="oninput"></textarea>
        </div>

        <div class="qr-preview qr-preview-sm">
            <label class="form-label">プレビュー</label>
            <div class="qr-image border border-1 border-dark rounded rounded-2">
                <QRCodeSvg Level="@_model!.Level" Body="@_model!.Body" width="100%" height="100%" />
            </div>
        </div>

        <div>
            <button class="btn btn-success w-100">保存</button>
        </div>
    </EditForm>
</div>

@code {
    private const int _nameLength = 30;

    private InputModel? _model;

    [SupplyParameterFromQuery(Name = "url")]
    private string? Url { get; set; }

    [SupplyParameterFromQuery(Name = "body")]
    private string? BodyQuery { get; set; }

    protected override void OnInitialized()
    {
        if (Url is { })
        {
            if (string.IsNullOrEmpty(new Uri(Url).Host)) Nav.NavigateTo(Url, false, true);
            else Nav.NavigateTo(string.Empty, false, true);
            return;
        }

        _model = new InputModel { Body = BodyQuery };
    }

    protected override void OnParametersSet()
    {
        _model ??= new InputModel();

        if (_model.Body != BodyQuery)
        {
            _model.Body = BodyQuery;
        }
    }

    private async Task OnGenerateAsync()
    {
        var svg = new ComponentRenderer<QRCodeSvg>().Set(t => t.Level, _model!.Level).Set(t => t.Body, _model!.Body).Render();

        using var stream = new MemoryStream();
        using var writer = new StreamWriter(stream, Encoding.UTF8);

        writer.Write(@"<?xml version=""1.0"" encoding=""utf-8""?>");
        writer.Write(svg);
        writer.Flush();

        stream.Position = 0;
        using var streamRef = new DotNetStreamReference(stream);

        var name = $"qrcode_{_model.Level}_{Trim(_model.Body!)}.svg";
        await JS.InvokeVoidAsync("downloadFileFromStream", name, streamRef);
    }

    private string? Body
    {
        get => _model?.Body;
        set
        {
            if (_model is null) return;
            _model.Body = value;
            UpdateUri();
        }
    }

    private void UpdateUri()
    {
        if (_model is null) return;

        var uri = string.IsNullOrEmpty(_model.Body)
            ? string.Empty
            : $"?body={Uri.EscapeDataString(_model.Body)}";

        Nav.NavigateTo(uri, false, true);
    }

    private string Trim(string src)
    {
        if (src.Length < _nameLength) return src;
        return src.Remove(_nameLength);
    }

    private class InputModel
    {
        public QRCodeGenerator.ECCLevel Level { get; set; }

        [Required]
        public string? Body { get; set; }
    }
}
